<!Doctype html>
<html>
    <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Maintenance Tracker App</title>
            <link rel="stylesheet" href="assets/css/styles.css">
            
        </head>
        <body>
            <div class="nav"> <!-- Navigation Menu Starts -->
                <label for="show-menu" class="show-menu">Show Menu</label>
                <input type="checkbox" id="show-menu" role="button">
             
                <ul id="menu">
                    
                   <li id="logo"><a href="index.html">Maintenance</a></li>
                               
                   <li><a href="index.html">Home</a></li>
                   <li><a href="my-requests.html" id="reqs">My Requests </a></li>
                   <li><a href="request-form.html" id="reqForm">Request Service </a></li>
                   <li id="login"><a href="index.html">Log Out</a></li> 
                </ul>
        </div> <!-- navigation menu ends -->

        <!--
            page content start
        -->
        <div class="cover">
        <div class="content">
            <div class="page-title">
                <h3>Request Form Page</h3>
            </div>
            
            <div class="form">
                <div class="form-header">
                    <h4>Need A Repair Or Maintenance?</h4>
                    <p>Place a request now and our team will get back to you.</p>
                    <p id="flash"></p>
                </div>
                <form id="request_form">
                    <div class="row">
                        <div class="col-lg-12 col-sm-12">
                            <label id="form-label">Service Type:</label>
                            <select id="category" name="serviceType">
                                <option value="">Select Service Type</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Repair">Repair</option>
                            </select>
                        </div>
                        <div class="col-lg-12 col-sm-12">
                            <label id="form-label">Location:</label>
                            <input type="text" id="location" name="location" placeholder="Location" required
                        </div>
                        <div class="col-lg-12 col-sm-12">
                            <label id="form-label">Description.</label> 
                            <textarea row="5" id="description" name="description" placeholder="Service Description" required></textarea>
                        </div>
                        <div class="col-lg-6 col-sm-12">
                            <input type="submit" class="btn-success" value="Submit"> 
                        </div>

                    </div>
                </form>              
            </div>

        </div>
      </div>
      <script type="text/javascript">
        window.onload = function() {
            const sub = localStorage.getItem('sub')
            const token = localStorage.getItem("token");
            let msg = localStorage.getItem("msg");
            document.getElementById('flash').style.color = 'green'
            document.getElementById('flash').innerHTML = msg
            localStorage.removeItem( 'msg' );
            requestForm()

            // Load create requests page 
            function requestForm(){

                fetch(sub + '/users/requests', {
                    method:"GET",
                    headers: {
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Credentials": true,
                        'Authorization': `Bearer ${token}`
                    }
                    })
                    .then((res) => res.json())
                    .then((data) => {
                        
                        console.log(data)
                        if(data.message) {
                            
                            localStorage.setItem("msg","Login To Continue");
                            window.location.href = 'login.html'
                        }
                    })

            }

            // Post requests 
            let req_form = document.getElementById('request_form')
            if (req_form){
                req_form.addEventListener
                ('submit', createRequest);
                
            }

            function createRequest(e){
                e.preventDefault();

                let location = document.getElementById('location').value;        
                let category = document.getElementById('category').value;        
                let description = document.getElementById('description').value;

                fetch(sub + '/users/requests', {
                    method:"POST",
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-type':'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body:JSON.stringify({category:category,
                        location:location, description:description})
                    })
                    .then((res) => {
                        return res.json()
                    })
                    .then((data) => {
                        if(data.message == "Successfully created") {
                            window.location.href = 'my-requests.html'

                        }else{
                            document.getElementById('flash').style.color = 'red'
                            document.getElementById('flash').innerHTML = data.message
                        }
                    })

            }

        }
     </script>

    </body>
</html>