<!Doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Maintenance Tracker App</title>
        <link rel="stylesheet" href="assets/css/styles.css">
        
    </head>
    <body>
        <div class="nav"> <!-- Navigation Menu Starts -->
            <label for="show-menu" class="show-menu">Show Menu</label>
            <input type="checkbox" id="show-menu" role="button">
         
            <ul id="menu">
                
               <li id="logo"><a href="index.html">Maintenance</a></li>
                           
               <li><a href="index.html">Home</a></li>
               <li><a href="my-requests.html" id="reqs">My Requests </a></li>
               <li><a href="request-form.html" id="reqForm">Request Service </a></li>
               <li id="login"><a href="index.html">Log Out</a></li> 
            </ul>
        </div> <!-- navigation menu ends -->

        <!--
            page content start
        -->
        <div class="cover" style="display:none;" id="myDiv">
         <div class="content">
            <div class="page-title">
                <h3>My Requests History</h3>
                <p id="flash"></p>
            </div>
            
            <div class="request">
               <table id="table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Type</th>
                      <th>Location</th>
                      <th>Description</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  
                  <tbody>
                    <tr>
                      <td></td>
                      <td></td>
                      <td></td>
                      <td><a href="request.html"></a> </td>
                      <td id="status-pending"></td>
                    </tr>
                     
                  </tbody>

               </table>
               <div >
                    <a href="request-form.html"><button class="btn-success">Place A New Request</button></a>
                </div>
            </div>
         </div>
        </div>
        <div class="loader"></div>

        <script type="text/javascript">
        window.onload = function() {
            const sub = localStorage.getItem('sub')
            const token = localStorage.getItem("token");

            // Load requests page 
            requestsList()

            function requestsList(){

                fetch(sub + '/users/requests', {
                    method:"GET",
                    headers: {
                        "Access-Control-Allow-Origin": "*",
                        "Access-Control-Allow-Credentials": true,
                        'Authorization': `Bearer ${token}`
                    }
                    })
                    .then((res) => res.json())
                    .then((resp) => {
                        
                        if(resp.response) {
                            document.getElementById("myDiv").style.display = "block";
                            let table = document.getElementById('table'); 
                            let data = resp.response         

                            for(let i = 0; i < data.length; i++){
                                // create a table row
                                let new_row = table.insertRow();
                                
                                // create a table cell
                                let no = new_row.insertCell(0);
                                let category = new_row.insertCell(1);
                                let location = new_row.insertCell(2);
                                let description = new_row.insertCell(3);
                                let status = new_row.insertCell(4);
                                let action = new_row.insertCell(5);

                                //add value to cell
                                no.innerHTML = i+1;
                                category.innerHTML = data[i].category;
                                location.innerHTML = data[i].location;
                                description.innerHTML ='<a href="request.html">'+ data[i].description + '</a>';
                                if(data[i].status == "Pending"){
                                    status.innerHTML = '<span id="status-pending">' + data[i].status + '</span>';
                                }else if(data[i].status == "Resolved"){
                                    status.innerHTML = '<span id="status-resolved">' + data[i].status + '</span>';
                                }else{
                                    status.innerHTML = '<span id="status-cancelled">' + data[i].status + '</span>';
                                }

                                if(data[i].status == "Pending"){
                                    action.innerHTML = '<a href="requestUpdate.html?reqId='+ data[i].id + '">Edit</a>';
                                }
                                
                                
                            }

                        }else{
                            localStorage.setItem("msg","Login To Continue");
                            window.location.href = 'login.html'
                        }
                    })

            }
        }
        </script>

    </body>
</html>